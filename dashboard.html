<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Noon Dashboard - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªÙˆØ¸ÙŠÙ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background:#f5f5f5; padding:20px; font-family:'Cairo', Arial, sans-serif; direction:rtl; text-align:right; }
        h1 { text-align:center; color:#111; margin-bottom:30px; }
        #stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:30px; }
        .stat-card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,0.05); transition:transform 0.2s; }
        .stat-card:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.1); }
        .stat-card h3 { margin-top:0; color:#005a9c; font-size:1.1em; }
        .stat-card p { font-size:2em; font-weight:bold; margin:0; color:#111; }
        #charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px; }
        #error-msg { background:#f8d7da; color:#721c24; padding:15px; border-radius:8px; text-align:center; display:none; margin:20px 0; }
        #loading-msg { background:#d1ecf1; color:#0c5460; padding:15px; border-radius:8px; text-align:center; margin:20px 0; }
        @media (max-width:768px) { #charts-grid { grid-template-columns:1fr; } }
    </style>
</head>
<body>
<h1>ğŸ“Š Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ØªÙˆØ¸ÙŠÙ - Noon</h1>

<div id="loading-msg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
<div id="error-msg"></div>

<div id="stats-grid">
    <div class="stat-card"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†</h3><p id="total-applicants">--</p></div>
    <div class="stat-card"><h3>Ø§Ù„Ù…Ø¤Ù‡Ù„ÙŠÙ† (Ø³ÙŠØ§Ø±Ø©+Ø®Ø¨Ø±Ø©)</h3><p id="total-qualified">--</p></div>
    <div class="stat-card"><h3>Ù…ØªØ§Ø­ÙŠÙ† ÙÙˆØ±Ø§Ù‹</h3><p id="total-available">--</p></div>
    <div class="stat-card"><h3>Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</h3><p id="total-today">--</p></div>
</div>

<div id="charts-grid">
    <div class="stat-card">
        <h3>Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù…Ø§Ø±Ø©</h3>
        <canvas id="emirate-chart" height="300"></canvas>
    </div>
    <div class="stat-card">
        <h3>Ø§Ù„Ù…Ø¤Ù‡Ù„ÙŠÙ† (Ø³ÙŠØ§Ø±Ø©/Ø®Ø¨Ø±Ø©)</h3>
        <canvas id="qualified-chart" height="300"></canvas>
    </div>
</div>

<script>
// Configuration - Update these values according to your Google Sheets setup
const SHEET_ID = '1AGpZc2JY9Yd190bPmH2Twkxe2ZccuxjRySgw3RI_vFm2XEyzrTLewXH5';
const API_KEY = 'oqecI-NOhnH-5Kc5z-WsTdT-afhX6-hkJyk-SXfO6-eRfBa';
const SHEET_RANGE = 'Sheet1!A:M'; // A to M columns (13 columns)

// Field indices based on form structure:
// 0=Full Name, 1=Phone Number, 2=Email, 3=Emirate, 4=Has Driving License, 
// 5=Has Valid Residency, 6=Owns Vehicle, 7=Vehicle Type, 8=Has Delivery Experience, 
// 9=Available Immediately, 10=Timestamp
const FIELD_INDEX = {
    FULL_NAME: 0,
    PHONE: 1,
    EMAIL: 2,
    EMIRATE: 3,
    DRIVING_LICENSE: 4,
    RESIDENCY: 5,
    OWNS_VEHICLE: 6,
    VEHICLE_TYPE: 7,
    DELIVERY_EXP: 8,
    AVAILABLE: 9,
    TIMESTAMP: 10
};

function showError(message) {
    const errorEl = document.getElementById('error-msg');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    document.getElementById('loading-msg').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-msg').style.display = 'none';
}

fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`)
 .then(r => {
    if (!r.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets');
    return r.json();
 })
 .then(d => {
    hideLoading();
    
    if (!d.values || d.values.length < 2) {
        showError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
        return;
    }
    
    const rows = d.values.slice(1); // Skip header row
    const total = rows.length;
    
    // Calculate statistics using correct field indices
    const hasVehicle = rows.filter(r => r[FIELD_INDEX.OWNS_VEHICLE] === 'Yes' || r[FIELD_INDEX.OWNS_VEHICLE] === 'Ù†Ø¹Ù…').length;
    const hasExperience = rows.filter(r => r[FIELD_INDEX.DELIVERY_EXP] === 'Yes' || r[FIELD_INDEX.DELIVERY_EXP] === 'Ù†Ø¹Ù…').length;
    const qualifiedBoth = rows.filter(r => 
        (r[FIELD_INDEX.OWNS_VEHICLE] === 'Yes' || r[FIELD_INDEX.OWNS_VEHICLE] === 'Ù†Ø¹Ù…') && 
        (r[FIELD_INDEX.DELIVERY_EXP] === 'Yes' || r[FIELD_INDEX.DELIVERY_EXP] === 'Ù†Ø¹Ù…')
    ).length;
    const available = rows.filter(r => 
        r[FIELD_INDEX.AVAILABLE] === 'Yes' || r[FIELD_INDEX.AVAILABLE] === 'Ù†Ø¹Ù…ØŒ Ù…ØªØ§Ø­ ÙÙˆØ±Ø§Ù‹'
    ).length;
    
    // Count today's applicants
    const today = new Date().toDateString();
    const todayCount = rows.filter(r => {
        const timestamp = r[FIELD_INDEX.TIMESTAMP];
        return timestamp && new Date(timestamp).toDateString() === today;
    }).length;
    
    // Emirate statistics
    const emirates = {};
    rows.forEach(r => {
        const emirate = r[FIELD_INDEX.EMIRATE] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        emirates[emirate] = (emirates[emirate] || 0) + 1;
    });
    
    // Update stat cards
    document.getElementById('total-applicants').textContent = total;
    document.getElementById('total-qualified').textContent = `${qualifiedBoth} (${total ? Math.round(qualifiedBoth/total*100) : 0}%)`;
    document.getElementById('total-available').textContent = `${available} (${total ? Math.round(available/total*100) : 0}%)`;
    document.getElementById('total-today').textContent = todayCount;
    
    // Qualified chart (Doughnut)
    new Chart(document.getElementById('qualified-chart'), {
      type: 'doughnut',
      data: { 
          labels: ['ÙŠÙ…ØªÙ„Ùƒ Ù…Ø±ÙƒØ¨Ø©', 'Ù„Ø¯ÙŠÙ‡ Ø®Ø¨Ø±Ø© ØªÙˆØµÙŠÙ„', 'Ù„Ø§ ÙŠÙ…ØªÙ„Ùƒ Ù…Ø±ÙƒØ¨Ø©', 'Ø¨Ø¯ÙˆÙ† Ø®Ø¨Ø±Ø©'], 
          datasets: [{ 
              data: [hasVehicle, hasExperience, total - hasVehicle, total - hasExperience], 
              backgroundColor: ['#28a745', '#007bff', '#dc3545', '#ffc107'],
              borderWidth: 2,
              borderColor: '#fff'
          }] 
      },
      options: { 
          responsive: true,
          plugins: {
              legend: { position: 'bottom' }
          }
      }
    });
    
    // Emirate chart (Pie)
    new Chart(document.getElementById('emirate-chart'), {
        type: 'pie',
        data: {
            labels: Object.keys(emirates),
            datasets: [{
                data: Object.values(emirates),
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d', '#343a40'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: { 
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
  })
  .catch(err => {
      showError(`Ø®Ø·Ø£: ${err.message}`);
      console.error('Dashboard error:', err);
  });
</script>
</body>
</html>
