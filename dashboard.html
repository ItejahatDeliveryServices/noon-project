<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Noon Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background:#f5f5f5; padding:20px; font-family:Arial, sans-serif; direction:rtl; text-align:right; }
        h1 { text-align:center; color:#111; }
        #stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; }
        .stat-card { background:#fff; border:1px solid #ddd; border-radius:8px; padding:20px; box-shadow:0 2px 4px rgba(0,0,0,0.05); }
        .stat-card h3 { margin-top:0; color:#005a9c; }
        .stat-card p { font-size:2em; font-weight:bold; margin:0; }
        #charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:30px; }
        @media (max-width:768px) { #charts-grid { grid-template-columns:1fr; } }
    </style>
</head>
<body>
<h1>لوحة تحكم التوظيف - Noon (نسخة معدلة)</h1>
<div id="stats-grid">
    <div class="stat-card"><h3>إجمالي المتقدمين</h3><p id="total-applicants">0</p></div>
    <div class="stat-card"><h3>المؤهلين (سيارة+خبرة)</h3><p id="total-qualified">0</p></div>
    <div class="stat-card"><h3>متاحين فوراً</h3><p id="total-available">0</p></div>
    <div class="stat-card"><h3>متقدمين اليوم</h3><p id="total-today">0</p></div>
</div>

<div id="charts-grid">
    <div class="stat-card">
        <h3>المتقدمين حسب الإمارة</h3>
        <canvas id="emirate-chart" height="300"></canvas>
    </div>
    <div class="stat-card">
        <h3>المؤهلين (سيارة/خبرة)</h3>
        <canvas id="qualified-chart" height="300"></canvas>
    </div>
</div>

<script>
// ** تم تحديث الحقول هنا **
const SHEET_ID = '1AGpZc2JY9Yd190bPmH2Twkxe2ZccuxjRySgw3RI_vFm2XEyzrTLewXH5';
const API_KEY = 'oqecI-NOhnH-5Kc5z-WsTdT-afhX6-hkJyk-SXfO6-eRfBa';
// ** تم تحديث النطاق إلى 11 عموداً (A:K) **
fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Sheet1!A:K?key=${API_KEY}`)
 .then(r => r.json())
 .then(d => {
    const rows = d.values.slice(1); // تجاهل الهيدر
    const total = rows.length;
    
    // ** تم تحديث المؤشرات (Indices) بناءً على الهيكل الجديد **
    // Column structure: 0=Name, 1=Phone, 2=Email, 3=Emirate, 4=License, 5=Residency, 6=Vehicle, 7=VehicleType, 8=DeliveryExp, 9=Available, 10=Timestamp
    const qualified = rows.filter(r => r[6] === 'Yes' || r[6] === 'نعم').length; // يمتلك مركبة
    const experienced = rows.filter(r => r[8] === 'Yes' || r[8] === 'نعم').length; // لديه خبرة
    const qualifiedAndExperienced = rows.filter(r => (r[6] === 'Yes' || r[6] === 'نعم') && (r[8] === 'Yes' || r[8] === 'نعم')).length;
    const available = rows.filter(r => r[9] === 'Yes' || r[9] === 'نعم، متاح فوراً').length;
    const today = rows.filter(r => r[10] && new Date(r[10]).toDateString() === new Date().toDateString()).length;
    
    // إحصائيات الإمارة
    const emirates = {};
    rows.forEach(r => {
        const emirate = r[3] || 'Unspecified';
        emirates[emirate] = (emirates[emirate] || 0) + 1;
    });
    
    // تحديث الأرقام في البطاقات
    document.getElementById('total-applicants').textContent = total;
    document.getElementById('total-qualified').textContent = `${qualifiedAndExperienced} (${total ? Math.round(qualifiedAndExperienced/total*100) : 0}%)`;
    document.getElementById('total-available').textContent = `${available} (${total ? Math.round(available/total*100) : 0}%)`;
    document.getElementById('total-today').textContent = today;
    
    // رسم بياني للمؤهلين
    new Chart(document.getElementById('qualified-chart'), {
      type: 'doughnut',
      data: { 
          labels: ['يمتلك مركبة', 'لديه خبرة', 'لا يمتلك', 'بدون خبرة'], 
          datasets: [{ data: [qualified, experienced, total - qualified, total - experienced], backgroundColor: ['#28a745', '#007bff', '#dc3545', '#ffc107'] }] 
      },
      options: { responsive: true }
    });
    
    // رسم بياني للإمارات
    new Chart(document.getElementById('emirate-chart'), {
        type: 'pie',
        data: {
            labels: Object.keys(emirates),
            datasets: [{
                data: Object.values(emirates),
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d', '#343a40']
            }]
        },
        options: { responsive: true }
    });
  });
</script></body></html>
